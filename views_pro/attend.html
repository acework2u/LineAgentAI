<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Volunteer Event</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-line {
            background-color: #00c300;
            color: white;
            border: none;
        }

        .btn-line:hover {
            background-color: #00a600;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #343a40;
        }

        .header p {
            color: #6c757d;
        }

        .event-details {
            margin-bottom: 20px;
        }

        .event-details h3 {
            font-size: 1.2rem;
            color: #495057;
        }

        .event-details p {
            color: #6c757d;
            margin: 5px 0;
        }

        .banner {
            width: 100%;
            height: auto;
            margin-bottom: 20px;
            border-radius: 8px;
        }
    </style>
</head>

<body>
<div class="container">
    <img src="https://hostpital-sd.s3.ap-southeast-7.amazonaws.com/S__29261992.png" alt="Event Banner" class="banner">
    <div class="header">
        <h1>โครงการแพทย์อาสาตรวจสุขภาพพระสงฆ์ถวายเป็นพระกุศล</h1>
        <p>แด่สมเด็จพระสงฆราช สกลมหาสังฆปริณายก</p>
        <p>ในวันอาทิตย์ที่ 9 กุมภาพันธ์ 2568 ณ วัดราชบพิธสถิตมหาสีมารามราชวรวิหาร</p>
    </div>
    <div class="mb-3 shadow-sm card text-center">
        <img src="https://hostpital-sd.s3.ap-southeast-7.amazonaws.com/1737515268758.jpg" class="card-img-top" alt="แผนผังงานกิจกรรม">
    </div>
    <div class="event-details">
        <h3>Event Details:</h3>
        <p><strong>Date:</strong> วันอาทิตย์ที่ 9 กุมภาพันธ์ 2568</p>
        <p><strong>Time:</strong> 9:00 AM - 4:00 PM</p>
        <p><strong>Location:</strong> ณ วัดราชบพิธสถิตมหาสีมารามราชวรวิหาร</p>
        <p><strong>Description:</strong> การแต่งกาย : ปธพ.1-10 และ ปนพ.1-2 ใส่เสื้อประจำรุ่น ปธพ.X เสื้อสีขาวโลโก้สมเด็จฯ</p>
    </div>
    <div class="mb-3 shadow-sm card text-center green-500 d-none" id="registerMemberCard">
        <h3>ท่านยังไม่่ได้เป็นสมาชิกแพทย์อาสา</h3>
        <p>กรุณาลงทะเบียนสมาชิก ก่อนเข้าร่วมกิจกรรม</p>
<!--         <button class="btn btn-line btn-lg w-100" id="member-register-btn">Register</button>-->
    </div>
    <div class="event-details mb-3 shadow-sm card text-center" id="joinEventCard">
        <h3 class="mt-3">เข้าร่วมกิจกรรม</h3>
        <p>โปรดระบุข้อมูลเพิ่มเติม เพื่อเข้าร่วมกิจกรรม</p>
        <p id="event-status" class="card-text green-500"></p>
        <button class="btn btn-line btn-lg w-100" id="member-register-btn">Register</button>
        <div class="card-body text-center">
            <div id="member-profile" class="mb-3 d-none">
            <p id="user-fullName" class="card-text"></p>
            <p id="user-phone" class="card-text"></p>
            <p id="user-email" class="card-text"></p>
            <p id="user-position" class="card-text"></p>
            <p id="user-organization" class="card-text"></p>
            <p id="user-course" class="card-text"></p>
            <div class="mb-3 d-none" id="joinEventDisplay">
                <p id="event-reference-name">ff</p>
                <p id="event-reference-phone">ff</p>
                <p id="event-clinic" class="card-text">ff</p>
                <p id="join-time"></p>
<!--            <a class="btn" href="https://liff.line.me/2006793268-Bp72Z8Lj" >Check In</a>-->
                <button class="btn btn-line btn-lg w-100" id="EventCheckInBtn">Press Check-In</button>
            </div>
            </div>

           <form class="form-inline d-none" id="joinEventForm">
            <input id="member-line-id" class="form-control me-2" type="hidden" placeholder="Enter your LINE ID" aria-label="Enter your LINE ID" />
            <input id="member-line-name" class="form-control me-2" type="hidden" placeholder="Enter your LINE name" aria-label="Enter your LINE name" />
            <div class="mb-2 mr-sm-2 mb-sm-0">
<!--                <label for="member-fullName" class="sr-only">Full Name</label>-->
                <input id="member-name" class="form-control me-2" type="hidden" placeholder="Enter your name" aria-label="Enter your name" />
                <input id="member-lastName" class="form-control me-2" type="hidden" placeholder="Enter your name" aria-label="Enter your name" />
                <input id="member-fullName" class="form-control me-2" type="hidden" placeholder="Enter your name" aria-label="Enter your name" />
            </div>
            <div class="mb-2 mr-sm-2 mb-sm-0">
<!--                <label for="member-phone" class="sr-only">ID</label>-->
                <input id="member-phone" class="form-control me-2" type="hidden" placeholder="Enter your phone number" aria-label="Enter your phone number" />
            </div>
            <div class="mb-2 mr-sm-2 mb-sm-0">
<!--                <label for="member-email" class="sr-only">Email</label>-->
                <input id="member-email" class="form-control me-2" type="hidden" placeholder="Enter your email" aria-label="Enter your email" />
            </div>
            <div class="mb-2 mr-sm-2 mb-sm-0">
                <input id="member-position" class="form-control me-2" type="hidden" placeholder="Enter your position" aria-label="Enter your position" />
                <input id="member-organization" class="form-control me-2" type="hidden" placeholder="Enter your organization" aria-label="Enter your organization" />
            </div>
            <div class="mb-2 mr-sm-2 mb-sm-0">
                <input id="member-course" class="form-control me-2" type="hidden" placeholder="Enter your course" aria-label="Enter your course" />
            </div>
            <div class="mb-2 mr-sm-2 mb-sm-0">
                <input id="reference-name" class="form-control me-2" type="text" placeholder="ระบุ ชื่อ - นามสกุล (บุคคลที่แนะนำ)" aria-label="Enter your reference name" />
            </div>
            <div class="mb-2 mr-sm-2 mb-sm-0">
                <input id="reference-phone" class="form-control me-2" type="text" placeholder="ระบุ เบอร์โทรศัพท์ (บุคคลที่แนะนำ)" aria-label="Enter your reference phone number" />
            </div>
            <div class="mb-2 mr-sm-2 mb-sm-0">
                <label for="clinic-select" class="sr-only">กรุณาเลือกคลินิก ที่ท่านต้องการ</label>
                <select id="clinic-select" class="form-select" aria-label="Default select example">
                    <option selected>กรุณาเลือกคลินิก ที่ท่านต้องการ</option>
                </select>
            </div>
            <button class="btn btn-line btn-lg w-100" id="joinEventBtn">Join the Event</button>
        </form>


        </div>

    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="errorModalMessage">
                    <!-- Error message will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!--Success Modal-->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success" id="successModalLabel">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="successModalMessage">
                    <-- Success message will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</div>



<script>

    const LIff_ID = "2006793268-nJZqYeWE";
    const baseUrl = "https://deepai.acework.info";
    const GET_PROFILE_API = `${baseUrl}/api/v1/profile`; // Replace with actual API endpoint
    const CHECK_REGISTRATION_API = `${baseUrl}/api/v1/check-registration`; // Replace with actual API endpoint
    const JOIN_EVENT_API = `${baseUrl}/api/v1/join-event`;
    const CHECK_JOIN_EVENT_API = `${baseUrl}/api/v1/check-join-event`;
    const CLINICS = [
        "ให้โครงการจัดให้ ตามความเหมาะสม",
        "คลินิกที่ 1 เจาะเลือด",
        "คลินิกที่ 2 ตรวจสุขภาพและคัดกรองทั่วไป",
        "คลินิกที่ 3 X-ray ปอด",
        "คลินิกที่ 4 ตรวจคลื่นไฟฟ้าหัวใจ",
        "คลินิกที่ 5 เวชศาสตร์ฟื้นฟูหัวใจ",
        "คลินิกที่ 6 กระดูกและข้อ",
        "คลินิกที่ 7 Fibro Scen",
        "คลินิกที่ 8 จักษุ",
        "คลินิกที่ 9 ผิวหนัง",
        "คลินิกที่ 10 ทันตกรรม",
        "คลินิกที่ 11 ตรวจสมรรถนะปอด",
        "คลินิกที่ 12 วัคซีนไข้หวัดใหญ่",
        "คลินิกที่ 13 อบรมการช่วยชีวิตขั้นพื้นฐาน (CPR)",
        "คลินิกที่ 14 ABI การตรวจวัดความแข็งของหลอดเลือด",
        "คลินิกที่ 15 อู่ข้าว-อู่น้ำ",
        "คลินิกที่ 16 แจกถุงบุญ"]

    // Handler User login
    async function handleUserLogin() {
        try{
            const profile = await liff.getProfile();
            const userId = profile.userId;
                fetchUserProfile(userId);
        }catch(error){

        }finally{
            console.log("finally");
        }
    }
    // Fetch User Profile
    async function fetchUserProfile(userId) {
        try {
            const response = await fetch(`${GET_PROFILE_API}?userId=${userId}`);
            const checkJoinEvent = await fetch(`${CHECK_JOIN_EVENT_API}?eventId=1&userId=${userId}`);

            const dataCheckEvent = await checkJoinEvent.json();
            // console.log(dataCheckEvent.eventJoin);

            // Check member join event
            if(dataCheckEvent.eventJoin){
                fetchGetEventJoin(userId);
                document.getElementById("joinEventCard").classList.remove("d-none");
                document.getElementById("member-profile").classList.remove("d-none");


            }else{
                document.getElementById("member-profile").classList.remove("d-none");
                document.getElementById("joinEventForm").classList.remove("d-none");
            }

            const lineProfile = await liff.getProfile();
            const checkMember = checkMemberRegistration(lineProfile.userId);

            if (checkMember) {
                const userData = await response.json();
                const dataUserInfo = userData.userInfo;
                // console.log(dataUserInfo);
                displayUserProfile(lineProfile,dataUserInfo);
            } else {
                // throw new Error("Failed to fetch user profile");
                redirectToRegistrationPage()
            }
        }catch (error) {

        }finally {

        }
    }
    async function fetchGetEventJoin(userId){
        try{
            // fetch get method
            const response = await fetch(`${JOIN_EVENT_API}?eventId=1&userId=${userId}`);
            if (response.ok) {
                const data = await response.json();
                displayEventJoin(data);
            }else {
                throw new Error("Failed to fetch user profile");
            }

        }catch (error) {
            // console.log(error);
        }finally {
            // console.log("finally");
        }
    }
    function displayUserProfile(lineProfile,dataUserInfo) {
       //console.log("this is dataUserInfo")
     //  console.log(dataUserInfo);
       const member = dataUserInfo.member;
       const fullName = dataUserInfo.name +" "+ dataUserInfo.lastName;

      // member profile
        document.getElementById("user-fullName").innerText = "ชื่อ-สกุล :"+fullName;
        document.getElementById("user-phone").innerText = "เบอร์โทร "+member.phone;
        document.getElementById("user-email").innerText = "อีเมล "+member.email;
        document.getElementById("user-organization").innerText = "หน่วยงานสังกัด "+member.organization;
        document.getElementById("user-course").innerText = "รุ่นหลักสูตร "+member.course;

       document.getElementById("member-name").value = member.name;
       document.getElementById("member-lastName").value = member.lastName;
       document.getElementById("member-line-id").value = lineProfile.userId;
       document.getElementById("member-line-name").value = lineProfile.displayName;
       document.getElementById("member-fullName").value = fullName;
       document.getElementById("member-phone").value = member.phone;
       document.getElementById("member-email").value = member.email;
       document.getElementById("member-position").value = member.position;
       document.getElementById("member-organization").value = member.organization;
       document.getElementById("member-course").value = member.course;
       document.getElementById("clinic-select").innerHTML = CLINICS.map(clinic => `<option value="${clinic}">${clinic}</option>`).join("");


    }
    function displayEventJoin(data){
        console.log("displayEventJoin")
        // console.log(data);
        const eventInfo = data.message
        if (eventInfo.eventCheckIn[0]){
        const memberCheckin = eventInfo.eventCheckIn[0];
        console.log(memberCheckin.checkIn);
        if (memberCheckin.checkIn){
            const checkInBtn  = document.getElementById("EventCheckInBtn");
            checkInBtn.disabled = true;
            const memberCheckInTime = new Date(memberCheckin.checkInTime *1000);
            checkInBtn.innerHTML = `latest checkin :<p>${memberCheckInTime.toLocaleDateString()} ${memberCheckInTime.toLocaleTimeString()}</p>`
            // convert data time to YYYY-MM-DD HH:MM

        }
        }

        // console.log(eventInfo);
        const joinTime = new Date(eventInfo.joinTime)
        document.getElementById("joinEventForm").classList.add("d-none");
        document.getElementById("joinEventBtn").classList.add("d-none");
        document.getElementById("joinEventDisplay").classList.remove("d-none");
        document.getElementById("event-reference-name").innerText = "ผู้แนะนำ: "+eventInfo.referenceName;
        document.getElementById("event-reference-phone").innerText = "เบอร์โทรผู้แนะนำ: "+eventInfo.referencePhone;
        document.getElementById("event-clinic").innerText = "คลินิก: "+eventInfo.clinic;
        document.getElementById("join-time").innerText = "ลงทะเบียนเมื่อเวลา: "+joinTime.toLocaleDateString()+" "+joinTime.toLocaleTimeString();
        document.getElementById("event-status").innerHTML = "<b class='green'>ลงทะเบียนกิจกรรมแล้ว</b>";


    }
    // an API call or saving function
    function joinEvent() {
        return new Promise( async (resolve, reject) => {
            try {
                const data = {
                    eventId: "1",
                    titleEvent:"โครงการแพทย์อาสาตรวจสุขภาพพระสงฆ์ถวายเป็นพระกุศล แด่สมเด็จพระสงฆราช สกลมหาสังฆปริณายก",
                    userId: document.getElementById("member-line-id").value,
                    lineName: document.getElementById("member-line-name").value,
                    name: document.getElementById("member-name").value,
                    lastName: document.getElementById("member-lastName").value,
                    tel: document.getElementById("member-phone").value,
                    email: document.getElementById("member-email").value,
                    position: document.getElementById("member-position").value,
                    organization: document.getElementById("member-organization").value,
                    course: document.getElementById("member-course").value,
                    lineId: document.getElementById("member-line-id").value,
                    referenceName: document.getElementById("reference-name").value,
                    referencePhone: document.getElementById("reference-phone").value,
                    clinic: document.getElementById("clinic-select").value,
                }
                const response = await fetch(JOIN_EVENT_API, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    const result = await response.json();
                    // console.log(result);
                    resolve(result);

                } else {
                    const error = await response.json();
                    // console.log(error);
                    reject(error);

                }

            } catch (error) {
                reject(error);
            }

        });
    }

    // Enable the "Join Event" button
    function enableMemberRegisterButton() {

        document.getElementById("event-status").innerHTML = "ท่านยังไม่ได้เป็นสามาชิก! กรุณาลงทะเบียนสมาชิกแพทย์อาสา เพื่อเข้าร่วมกิจกรรม"
        const joinButton = document.getElementById("member-register-btn");
        joinButton.disabled = false;
        joinButton.addEventListener("click", redirectToRegistrationPage);
    }

    // Check if the user is registered
    async function checkMemberRegistration(userId) {
        try {
            const response = await fetch(CHECK_REGISTRATION_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: userId
                })
            });
            const data = await response.json();
            // console.log("in checkMemberRegistration on attend")
            // console.log(data.isRegistered);
            return data.isRegistered;
        }catch (error) {
            // console.log(error);
            return false;
        }
    }

    //Redirect to Liff registration page
    function redirectToRegistrationPage() {
        const registerUrl = "https://liff.line.me/2006793268-7rZrb1Kw";
        liff.openWindow({ url: registerUrl, external: true });

    }

    async function initializeLiff(){
        try {
            await liff.init({ liffId: LIff_ID});
            console.log("LIFF initialized");
            if (!liff.isLoggedIn()) {
                liff.login();
            }else{
                const profile = await liff.getProfile();
                const userId = profile.userId;
                const checkMember = await checkMemberRegistration(userId);

                // console.log("check member is",checkMember);

                if (checkMember){
                    // Handler user login
                    document.getElementById("member-register-btn").classList.add("d-none");
                    handleUserLogin();
                } else{
                    // redirectToRegistrationPage();
                    enableMemberRegisterButton();
                }
            }

        }catch (error) {
            // console.log("Liff Initialization Failed:",error);
        }
    }

    async function initializeLiff2(){
        liff.init({
        liffId: LIff_ID,
    }).then( async () => {
            console.log("LIFF initialized");
            document.getElementById("event-status").innerText = "loading..."
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                const userId = profile.userId;
                const checkMember = await checkMemberRegistration(userId);

                // console.log("check member is",checkMember);
                if (checkMember){
                    // Handler user login
                    document.getElementById("member-register-btn").classList.add("d-none");
                    document.getElementById("event-status").innerText = ""
                    handleUserLogin();
                } else{
                    // redirectToRegistrationPage();
                    enableMemberRegisterButton();
                }
            } else {
                 liff.login();
            }
    }).catch((err) => {
        // console.log("Error initializing LIFF:", err);
        })

    }


    function showSuccessModal(message) {
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        document.getElementById('successModalMessage').innerText = message;
        successModal.show();
    }
    function showErrorModal(message) {
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        document.getElementById('errorModalMessage').innerText = message;
        errorModal.show();
    }
    function showLoadingModal() {
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();
    }
    // Function to validate mobile number
    function validateMobileNumber(phoneNumber) {
        // Regex for a valid mobile number (10 digits, optional + and country code)
        const regex = /^\+?(\d{1,4})?[-.\s]?\(?\d{1,4}\)?[-.\s]?\d{1,4}[-.\s]?\d{1,9}$/;
        return regex.test(phoneNumber);
    }

    document.addEventListener('DOMContentLoaded',initializeLiff2);

    document.getElementById("joinEventBtn").addEventListener("click", async () => {
        if (!liff.isLoggedIn()) {
           return liff.login();
        } else {
            let isValid = true;
            const referenceName = document.getElementById("reference-name").value;
            const referencePhone = document.getElementById("reference-phone").value;

            //
            // if (!referenceName || !referencePhone) {
            //     isValid = false;
            //
            //     if (referenceName.length < 1) {
            //         document.getElementById("reference-name").focus();
            //         document.getElementById("reference-name").classList.add("is-invalid");
            //     }
            //     if (referencePhone.length < 1) {
            //         document.getElementById("reference-phone").focus();
            //         document.getElementById("reference-phone").classList.add("is-invalid");
            //     }
            //
            // }
            if (isValid) {

                const result = await joinEvent();
                // console.log(result);
                // alert(result.message);

                location.reload();

                try {}catch (error) {
                    console.log(error);
                    alert(error.error);
                }



            }

        }
    });
    const button = document.getElementById("EventCheckInBtn");
    if (button) {
        button.addEventListener("click", () => {
            window.location.href = "https://liff.line.me/2006793268-Bp72Z8Lj";
        });
    } else {
        console.error("Element 'EventCheckInBtn' not found.");
    }
    document.getElementById('reference-phone').addEventListener('keydown', function () {
        const phoneNumber = this.value.trim();
        const errorElement = document.getElementById('reference-phone');

        if (validateMobileNumber(phoneNumber)) {
            errorElement.textContent = '';
        } else {
            document.getElementById("reference-phone").classList.add("is-invalid");
            errorElement.textContent = 'Invalid mobile number. Please enter a valid number.';
        }
    });
    // Populate courses dropdown
    function populateCoursesDropdown() {
        const dropdown = document.getElementById('clinic-select');
        dropdown.innerHTML = '';

        // Default option
        const defaultOption = document.createElement('option');
        defaultOption.text = '<--เลือกคลีนิค-->';
        defaultOption.value = '';
        dropdown.appendChild(defaultOption);

        // Add courses
        CLINICS.forEach(course => {
            const option = document.createElement('option');
            option.text = course;
            option.value = course;
            dropdown.appendChild(option);
        });
    }
    // Pre-select a course
    function preselectCourse(value) {
        const dropdown = document.getElementById('clinic-select');
        dropdown.value = value;
    }

    // Initialize dropdown
    // populateCoursesDropdown();


</script>
</body>

</html>
